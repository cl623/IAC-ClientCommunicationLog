<script>
/*
 * 
 *
 *
 */
  var width = 1;
  var data;
  var id;
  var user;
  var staffId;
 //=================================================================================================================================================================
 //-----------------------------------Progress Bar--------------------------------------------------------------------------------------------------------------
 //=================================================================================================================================================================

var SuccessTime = 3000;
function move() {
  width=1;
  $("#myBar").show();
  var elem = document.getElementById("myBar");
  var move = setInterval(frame, 50);
  function frame() {
    if (width >= 90) {
      clearInterval(move);
    } else {
      width++;
      elem.style.width = width + '%';
    }
  }
  google.script.run.withSuccessHandler(setUser).getUser();
  google.script.run.withSuccessHandler(setStaffId).loadStaff();
}

function showMessage(msg){
    clearInterval(move)
    $("#clientName").prop( "disabled", false );
    $("#user").html("Logged in as: <strong>" + user + "</strong>");
	$("#SuccessMsg").show(800);
    var elem = document.getElementById("myBar");
    var move = setInterval(frame, 5);
    function frame() {
      if (width >= 100) {
        clearInterval(move);
        $("#myBar").hide(150);
      } else {
        width++;
       elem.style.width = width + '%';
      }
    }

	$("#spnMsg").text(msg);
	  setTimeout(function(){
		$(".myAlert-top").hide(800); 
	  }, SuccessTime);
}

function showEMessage(msg){
	$("#ErrorMsg").show(800);
    $("#user").html("Logged in as: <strong>" + user + "</strong>");
    $("#myBar").hide();
	$("#spnEMsg").text(msg);
	  setTimeout(function(){
		$(".myAlert-top").hide(1500); 
	  }, SuccessTime);
}

 //=================================================================================================================================================================
 //-----------------------------------Client Name List--------------------------------------------------------------------------------------------------------------
 //=================================================================================================================================================================
 
/*
 *
 * Fill select box with client names from spreadsheet
 * @param {String []} clientList Array from getClientName
 *
 */
 
 $(document).ready(function(){
  move();
  $('.select').select2({
    placeholder:'wweeee',
    width:'25%'
  });

  setInterval(refreshData, 300000);  
  
  });
  
  function clientInfo(option){
    var clientId = $("#clientName option:selected").val();
    $("#clientName").prop( "disabled", true );
    id = clientId;
    $('#commTable tbody tr').remove();
    width=1;
    $('#myBar').show(100)
    var elem = document.getElementById("myBar");
    var move = setInterval(frame, 15);
    function frame() {
      if (width >= 100) {
        clearInterval(move);
      } else {
        width++;
       elem.style.width = width + '%';
      }
    }
    if(id == 'All Clients'){
      $('#allClientsHeader').show()
      $('#defaultHeader').hide()
      google.script.run.withSuccessHandler(displayLogs).loadLogs(id, staffId);
      }
    else{
      $('#allClientsHeader').hide()
      $('#defaultHeader').show()
      google.script.run.withSuccessHandler(displayLogs).loadLogs(clientId,staffId);
      }
  }
  
  function displayLogs(data){
    
    var logs = JSON.parse(data);
    $.each(logs, function(index,object){
      var tr = $('<tr class=row title="Communication note submitted on: '+object['Timestamp']+'"></tr>');
      $.each(object,function(key,value){
        if(key!='Timestamp'){
          if(key=='DurationOfComm'){
            value = Math.ceil(value/60);
          }
          if(key=='ClientId'){
            value += " " + object['ClientName']
          }
          if(key!='ClientName')
            $('<td id="'+key+'" >'+value+'</td>').appendTo(tr);
        }
      });
      tr.appendTo('#commTable tbody');
      
    });
    console.log(logs)
    console.log(id)
    $("#clientName").prop( "disabled", false );
    $("#myBar").hide(150);
  }
  
  function setStaffId(data){
    var info = JSON.parse(data);
    $.each(info,function(index,object){
      if(object['IacEmail'] == user){
        staffId = object['StaffId'];
      }
    });
    google.script.run.withSuccessHandler(selectFill).cacheClientNameLog(staffId);
    return staffId;
  }
  
  function selectFill(list){
    var names = JSON.parse(list);
    var clientList = [];
    $.each(names,function(index,row){
        var fillName = row['Name'];
        var fillClientId = row["ClientId"];
        var o = new Option( fillName+' | '+fillClientId, fillClientId);
        $("#clientName").append(o);
        clientList.push(fillName);
        });
    
    if(clientList.length > 0){
      showMessage('Client data loaded');
    }
    else{
      showEMessage('No clients to view. ');
    }
  }
  
  function refreshData(){
    if($('[name=clientName]').val() != 0)
      google.script.run.withSuccessHandler(displayLogs).loadLogs(id,staffId);

  }

  function setUser(email){
    user = email;
  }
  
  function submitForm(){
    var data = $('#form').serializeArray().reduce(function(obj, item) {
    obj[item.name] = item.value;
    return obj;
    }, {});
  }
  
  
  
</script>
